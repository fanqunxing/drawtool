<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<link rel="stylesheet" type="text/css" href="../src/drawTool.css">
	<script type="text/javascript" src="../src/drawTool.js"></script>
	<script type="text/javascript" src="jquery-1.12.2.js"></script>
	<style type="text/css">
		*{
			margin: 0px;
			padding: 0px;
		}
		#canvas{
			width: 800px;
			height: 400px;
			border: solid 1px red;
			margin: auto;
			background: #fafafa;
		}
		.node{
			width: 40px;
			height: 40px;
			text-align: center;
    		line-height: 40px;
    		border:solid 1px red;
			cursor: pointer;
			border-radius: 50%;
		}
		.in{
			/*width: 20px;*/
			/*background:red;*/
		}
		.option {
			display: none;
		}
	</style>
</head>
<body>
	<table>
		<tr>
			<td>
				<table>
					<tr>
						<td>
							<div class='node js-node'>
								<div>test</div>
								<button class="option">删除</button>
							</div>
						</td>
					</tr>
					<tr>
						<td>
							<button onclick="addNode()">新增节点</button>
						</td>
					</tr>
					<tr>
						<td>
							<button onclick="save()">保存</button>
						</td>
					</tr>
					<tr>
						<td>
							<button onclick="clear()">清除</button>
						</td>
					</tr>
				</table>
			</td>
			<td>
				<div id="canvas" class="canvas"></div>
			</td>
		</tr>
	</table>
	<script type="text/javascript">
		var canvas = document.getElementById('canvas');
		var setting = {
			lineColor: '#26b7d0',
			lineHoverColor: '#aaa',
			arrowColor: '#444',
			// lineStyle: 'none'// arrow, none
		}
		var drawTool = new DrawTool(canvas, setting);

		
		var index = 65;
		function addNode() {
			var option = {
				pos:{x:20,y:20},
				html:"<div class='node js-node'>\
						<div class='in'>"+ String.fromCharCode(index) +"</div>\
						<button class=\"option\">删除</button>\
					  </div>",
				// html: "<div class='node js-node'>"+ String.fromCharCode(index) +"</div>",
				anchors:[[0, 20],[40, 20],[20, 0],[20, 40]]
			};
			drawTool.addNode(option);
			index++; 
		};

		$("#canvas").delegate('.js-node', 'mousemove', function(e) {
			$(this).find('.option').show();
		});

		$("#canvas").delegate('.js-node', 'mouseleave', function() {
			$(this).find('.option').hide();
		});

		$("#canvas").delegate('.option', 'click', function() {
			var nodeid = $(this).closest('.js-node').get(0).nodeid;
			drawTool.deleteNodeById(nodeid);
		});
		
		// promise jq


		drawTool.listen({
			clickLine: function( line ){
				console.log( line );
			},
			deleteLine: function( line ){
				return true;
			},
			lineTo: function( line ){
				console.log( line );
				return true;
			},
			// 点击节点事件
			clickNode: function( node ) {
				console.log(node);
			}
		});


		function save() {
			var lineArr = drawTool.getAllLines();
			var nodeArr = drawTool.getAllNodesInfo();
			localStorage.setItem('lineArr', JSON.stringify(lineArr));
			localStorage.setItem('nodeArr', JSON.stringify(nodeArr));
		};

		function clear() {
			// localStorage.setItem('lineArr', '');
			// localStorage.setItem('nodeArr', '');
			localStorage.clear();
		}

		function init() {
			var lineArr = JSON.parse(localStorage.getItem('lineArr'));
			var nodeArr = JSON.parse(localStorage.getItem('nodeArr'));

			drawTool.init(nodeArr, lineArr);
		};

		init();
		// try{
		// 	init();
		// }catch(e) {
		// }
		
	</script>
</body>
</html>