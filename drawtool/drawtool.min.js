/*
 * drawTool.js v1.2.0
 * (c) fwx426328
 */
(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?module.exports=t():typeof define==="function"&&define.amd?define(t):typeof define==="function"&&define.cmd?define(t):e.Drawtool=t()})(this,function(){"use strict";var Je="1.2.0";var e=Object.prototype;var o=Array.prototype;var t=e.toString;var n=e.hasOwnProperty;var Ae=new Function;function Pe(e){return Math.sin(e)}function Se(e){return Math.cos(e)}function r(e){return Math.tant(e)}function Ie(e){return Math.atan(e)}function je(e){return Math.sqrt(e)}function Me(e,t){return Math.pow(e,t)}function De(e){return e!==undefined&&e!==null}function He(e){return e===true}function Xe(e){return e===false}function ze(e){return t.call(e)==="[object Function]"}function Ye(e){return t.call(e)==="[object Array]"}function Ve(e){return o.slice.call(e)}function Oe(e){var t=parseFloat(e);return isNaN(t)?e:t}function Re(e){return e!==null&&typeof e==="object"}function Fe(e){return e&&e.length>0}function i(e,t){return n.call(e,t)}function a(e,t){var n;for(n in e){if(i(e,n)){if(t(e[n],n)){break}}}}function We(n,e,r){if(e){a(e,function(e,t){if(He(r)||!i(n,t)){n[t]=e}})}return n}function qe(e){e=We(e,{before:Ae,fun:Ae,after:Ae});return function(){e.before.apply(e.func,arguments);e.fun.apply(e.func,arguments);e.after.apply(e.func,arguments)}}function Ue(e,t){var n=Object.create(null);var r=e.split(",");for(var o=0;o<r.length;o++){n[r[o]]=true}return t?function(e){e=e||"";return n[e.toLowerCase()]}:function(e){return n[e]}}function Ge(e,t,n){var r={};var o=(t.x-e.x)/n;var i=(t.y-e.y)/n;for(var a=0;a<=n;a++){var l=e.x+a*o;var s=e.y+a*i;r["d"+a]={x:l,y:s}}return function(e){return r[e]}}function $e(e){var t={};if(Ye(e)){t={x:e[0],y:e[1]}}return t}function Ke(e){var t=[];if(Re(e)){t[0]=e.x;t[1]=e.y}return t}function Qe(e){throw new Error("drawtool.js error: "+e)}function l(e){console.error("drawtool.js warn: "+e)}function Ze(e){return!!(e&&e.nodeType)}function _e(e){return e.offsetWidth}function et(e){return e.offsetHeight}function s(e,t){var n=" ";return(n+e.className+n).indexOf(n+t+n)>-1}function tt(t,e){if(Ye(e)){e.forEach(function(e){tt(t,e)})}else{if(!t.className){t.className=e}else{t.className=t.className+" "+e}}return t}function c(e,t){if(s(e,t)){var n=" ";var r=n+e.className.replace(/[\t\r\n]/g,"")+n;while(r.indexOf(n+t+n)>=0){r=r.replace(n+t+n,n)}e.className=r.replace(/^\s+|\s+$/g,"")}return e}function nt(e,t,n){if(e==t){return null}if(s(t,n)){return t}else{return nt(e,t.parentNode,n)}}function rt(e,t){if(Ze(e)){if(He(t)){!s(e,lt.showVisCss)&&tt(e,lt.showVisCss);s(e,lt.hideVisCss)&&c(e,lt.hideVisCss)}else{!s(e,lt.showCss)&&tt(e,lt.showCss);s(e,lt.hideCss)&&c(e,lt.hideCss)}}else{Ve(e).forEach(function(e){rt(e,t)})}return e}function ot(e,t){if(Ze(e)){if(He(t)){!s(e,lt.hideVisCss)&&tt(e,lt.hideVisCss);s(e,lt.showVisCss)&&c(e,lt.showVisCss)}else{!s(e,lt.hideCss)&&tt(e,lt.hideCss);s(e,lt.showCss)&&c(e,lt.showCss)}}else{Ve(e).forEach(function(e){ot(e,t)})}return e}function u(e,t,n){var r=new XMLHttpRequest;r.open("GET",e,true);r.onreadystatechange=function(){if(r.readyState==4&&r.status==200){t(r.status,r.responseText)}else if(r.readyState==4){n(r.status,r.responseText)}};r.send()}function it(o){var e=document.getElementsByTagName("link");var t=Ve(e);var i=[];while(t.length){var n=t.pop();(function(r){u(n.href,function(e,t){var n=document.createElement("style");n.innerHTML=t;i.push(n);!r&&o(i)},function(e,t){l("get style fail , please check =>"+n.href);!r&&o(i)})})(t.length)}}var at=new Object;at.on=function(e,t,n){if(e.addEventListener){at.on=function(e,t,n){e.addEventListener(t,n,false)}}else{at.on=function(e,t,n){e.attachEvent("on"+t,n)}}at.on(e,t,n)};at.delegate=function(r,o,e,i){at.on(r,e,function(e){var e=window.event||e;var t=e.target||e.srcElement;var n=nt(r,t,o);if(n){i.call(n,e)}},false)};at.off=function(e,t,n){if(e.removeEventListener){at.off=function(e,t,n){e.removeEventListener(t,n,false)}}else{at.off=function(e,t,n){e.detachEvent("on"+t,n)}}at.off(e,t,n)};var lt={showCss:"drawtool-show",hideCss:"drawtool-hide",showVisCss:"drawtool-visibility-show",hideVisCss:"drawtool-visibility-hide",rootCss:"drawtool-content-root",ndCss:"drawtool-node",ndJs:"js-drawtool-node",inNdJs:"js-drawtool-inner-node",anchorCss:"drawtool-anchor",anchorJs:"js-drawtool-anchor",menuCss:"drawtool-operate",menuBtnCss:"drawtool-operate-btn",menuBtnJs:"js-drawtool-operate-btn",menuDeleteCss:"drawtool-operate-delete",menuDeleteJs:"js-drawtool-operate-delete",menuEditJs:"js-drawtool-operate-edit",menuEditCss:"drawtool-operate-edit",controller:"drawtool-controller",ctrlli:"drawtool-controller-li",ctrlJs:"js-drawtool-controller-li",cvs:"drawtool-canvas",bgCvs:"drawtool-background-canvas",avCvs:"drawtool-active-canvas"};function st(e){var t="";var n=document.getElementsByTagName("style");e=e.concat(Ve(n));e.forEach(function(e){if(Ze(e)){t+=e.outerHTML.replace(/#/g,"%23").replace(/\n/g,"%0A")}});return t}function ct(e,t,n){var r=e.cloneNode(true);r.setAttribute("xmlns","http://www.w3.org/1999/xhtml");r.classList.remove("outline");var o='data:image/svg+xml;charset=utf-8,\t  <svg xmlns="http://www.w3.org/2000/svg" width="'+n.width+'" height="'+n.height+'">\t\t<foreignObject x="0" y="0" width="100%" height="100%">'+(new XMLSerializer).serializeToString(r).replace(/#/g,"%23").replace(/\n/g,"%0A")+t+"</foreignObject>\t  </svg>";return o}function ut(e){var t=document.createElement("canvas");t.width=_e(e);t.height=et(e);e.appendChild(t);return t}function ft(e,t){e.clearRect(0,0,_e(t),et(t))}function f(e){var t=window.event||e;var n=document.documentElement.scrollLeft||document.body.scrollLeft;var r=document.documentElement.scrollTop||document.body.scrollTop;var o=t.pageX||t.clientX+n;var i=t.pageY||t.clientY+r;return{x:o,y:i}}function dt(e,t){var n=f(t);var r=e.getBoundingClientRect();var o=document.documentElement.scrollLeft||document.body.scrollLeft;var i=document.documentElement.scrollTop||document.body.scrollTop;var a=r.left+o;var l=r.top+i;return{x:n.x-a,y:n.y-l}}function vt(n){a(n,function(e,t){if(t.indexOf("Js")>-1){n[t]+="-"+Math.floor(Math.random()*(new Date).getTime())}})}function ht(r){var o=[];if(Ye(r.anchors)){r.anchors.forEach(function(e,t){var n=document.createElement("span");tt(n,[lt.anchorCss,lt.anchorJs]);n.anchorid=t;n.pos=[e[0],e[1]];n.setAttribute("anchorNode-id",t);r.appendChild(n);o.push(n);n.style.left=e[0]-_e(n)/2+"px";n.style.top=e[1]-et(n)/2+"px"})}return o}function yt(e){var t=document.createElement("div");t.className=lt.menuCss;t.innerHTML='<span class="'+lt.menuBtnCss+" "+lt.menuDeleteCss+" "+lt.menuBtnJs+'">\t  <i class="'+lt.menuDeleteJs+'"></i>\t</span>\t<span class="'+lt.menuBtnCss+" "+lt.menuEditCss+" "+lt.menuBtnJs+'">\t  <i class="'+lt.menuEditJs+'"></i>\t</span>';e.appendChild(t);return ot(t)}function mt(e){var t=document.createElement("ul");t.className=lt.controller;var n=document.createElement("li");n.className=lt.ctrlli+" "+lt.ctrlJs;n.ctrlFlag=1;var r=document.createElement("li");r.className=lt.ctrlli+" "+lt.ctrlJs;r.ctrlFlag=2;t.appendChild(n);t.appendChild(r);e.appendChild(t);ot(t);var o={ctrl1:n,ctrl2:r,ctrl:t};return function(e){return o[e]}}function pt(e,t){var n=null;e.forEach(function(e){if(s(e,lt.anchorJs)){if(e.anchorid==t){n=e;return false}}});return n}function gt(){this.length=0}gt.prototype={constructor:gt,pop:o.pop,forEach:o.forEach,peek:function(){return this.length>0?this[this.length-1]:undefined},push:function(e){var t=0;this.forEach(function(e){if(e.nodeid>t){t=e.nodeid}});e.nodeid=e.nodeid||Number(t)+1;o.push.call(this,e);return e},getNodeById:function(e){var t=null;for(var n=0;n<this.length;n++){var r=this[n];if(r.nodeid==e){t=r;break}}return t},deleteById:function(e){var t=null;for(var n=0;n<this.length;n++){var r=this[n];if(r.nodeid==e){r.remove();o.splice.call(this,n,1);break}}return t},clear:function(){for(var e=0;e<this.length;e++){this[e].remove()}this.length=0},toArray:function(){var e=[];for(var t=0;t<this.length;t++){e.push(this[t])}return e},fiterData:function(){var e=[];for(var t=0;t<this.length;t++){var n=this[t];var r=Oe(n.style.left);var o=Oe(n.style.top);var i={template:n.template,nodeid:n.nodeid,pos:{x:r,y:o},anchors:n.anchors};e.push(i)}return e}};function xt(){this.length=0}xt.prototype={constructor:xt,pop:o.pop,forEach:o.forEach,peek:function(){return this.length>0?this[this.length-1]:undefined},push:function(e){var t=0;for(var n=0;n<this.length;n++){if(this[n].lineid>t){t=this[n].lineid}}e.lineid=e.lineid||t+1;o.push.call(this,e);return e},addAll:function(e){var t=this;e.forEach(function(e){t.push(e)});return t},deleteById:function(e){var t=new xt;for(var n=0;n<this.length;n++){if(this[n].lineid==e){t.push(this[n]);o.splice.call(this,n,1);break}}return t},deleteByNodeId:function(e){var t=new xt;for(var n=0;n<this.length;n++){if(this[n].startNodeid==e||this[n].endNodeid==e){t.push(this[n]);o.splice.call(this,n,1);n--}}return t},getLineById:function(e){var t=null;for(var n=0;n<this.length;n++){var r=this[n];if(r.lineid==e){t=r;break}}return t},toArray:function(){var e=[];for(var t=0;t<this.length;t++){e.push(this[t])}return e},fiterData:function(){var e=[];for(var t=0;t<this.length;t++){var n=this[t];var r={lineid:n.lineid,startNodeid:n.startNodeid,startAnchorid:n.startAnchorid,endNodeid:n.endNodeid,endAnchorid:n.endAnchorid,ctrl1:n.ctrl1,ctrl2:n.ctrl2,lineType:n.lineType,lineStyle:n.lineStyle,auto:n.auto};e.push(r)}return e},clear:function(){while(this.length){this.pop()}}};var d=Ue("broken,bezier,straight",true);var v=Ue("arrow,none",true);function wt(){this.lineid=null;this.startNodeid=null;this.startAnchorid=null;this.startElem=null;this.endNodeid=null;this.endAnchorid=null;this.endElem=null;this.ctrl1=[];this.ctrl2=[];this.lineType=null;this.status=0;this.lineStyle=null;this.auto=null}wt.prototype={constructor:wt,setType:function(e){if(d(e)){this.lineType=e}return this},setStyle:function(e){if(v(e)){this.lineStyle=e}return this},setAuto:function(e){this.auto=!!e;return this},setStart:function(e){this.startNodeid=e.parentNode.nodeid;this.startAnchorid=e.anchorid;this.startElem=e;this.status=1;return this},setEnd:function(e){this.endNodeid=e.parentNode.nodeid;this.endAnchorid=e.anchorid;this.endElem=e;this.status=2;return this}};function h(e,t){if(!Ze(e)){Qe(e+" is not dom");return}vt(lt);var n=false;var f=e;var r=ut(f);var H=r.getContext("2d");var d=ut(f);var o=d.getContext("2d");var l=new gt;var i=new xt;var a=new wt;var s=new xt;var c=null;var X=5;var u=null;var v=yt(f);var h=mt(f);var m=null;var p=false;!Re(t)&&(t={});var g=We(t,{lineColor:"#26b7d0",lineHoverColor:"rgba(200, 200, 200, 0.4)",lineActiveColor:"#2177C7",arrowColor:"#444",lineStyle:"arrow",lineType:"bezier",auto:true});var x={clickLine:Ae,deleteLineBefore:function e(){return true},deleteLineAfter:Ae,linkLineStart:Ae,linkLineBefore:function e(){return true},linkLineAfter:Ae};tt(f,lt.rootCss);tt(d,[lt.cvs,lt.bgCvs]);tt(r,[lt.cvs,lt.avCvs]);var w=qe({before:function(){if(a.status===0)at.on(f,"mousemove",q)},fun:function(e){if(Xe(n)){W(e)}},after:function(){if(a.status===0)at.off(f,"mousemove",q)}});var C=qe({fun:function(e){if(Xe(n)){O(e)}},after:function(){at.on(f,"mousemove",R)}});var E=qe({fun:function(e){if(Xe(n)){F(e)}},after:function(){at.off(f,"mousemove",R)}});var T=qe({fun:function(e){if(Xe(n)){D(e)}},after:function(){at.off(f,"mousemove",z)}});var b=qe({fun:function(e){if(Xe(n)){M(e)}},after:function(){at.on(f,"mousemove",z)}});var k=qe({fun:function(e){if(Xe(n)){U(e)}}});var N=qe({fun:function(e){if(Xe(n)){G(e)}}});var B=qe({fun:function(e){if(Xe(n)){J(e)}}});var L=qe({fun:function(e){if(Xe(n)){S(e)}}});function J(e){var t=nt(f,e.target,lt.ndJs);clearTimeout(t.hideTimer);var n=t.getElementsByClassName(lt.anchorJs);rt(n,true)}function A(e){var t=nt(f,e.target,lt.ndJs);clearTimeout(t.hideTimer)}function P(e){var t=nt(f,e.target,lt.ndJs);var n=t.getElementsByClassName(lt.anchorJs);t.hideTimer=setTimeout(function(){ot(n,true)},300)}function S(e){var t=nt(f,e.target,lt.ndJs);var n=t.getElementsByClassName(lt.anchorJs);t.hideTimer=setTimeout(function(){ot(n,true)},300)}function I(e){var t=window.event||e;a=new wt;$();pe();t.preventDefault()}function j(e){var t=window.event||e;t.preventDefault()}function M(e){m=e.target;m.relX=e.clientX-m.offsetLeft;m.relY=e.clientY-m.offsetTop;if(Fe(i)&&Xe(p)&&De(u)){s=i.deleteById(u.lineid);me();pe();p=true}}function D(){if(He(p)){i.addAll(s);s.clear();me();pe();p=false}}function z(e){if(Ze(m)){var t=e.clientX-m.relX;var n=e.clientY-m.relY;m.style.left=t+"px";m.style.top=n+"px";var r=t+m.offsetWidth/2;var o=n+m.offsetHeight/2;u["ctrl"+m.ctrlFlag]=[r,o];pe()}}function Y(){var e=x.deleteLineBefore.call(this,u);if(Xe(e)){return}i.deleteById(u.lineid);x.deleteLineAfter.call(this,u);$();ot(v);me();pe()}function V(e){rt(h("ctrl"));ot(v);var t=h("ctrl1");var n=h("ctrl2");var r=ee(u.startElem);var o=ee(u.endElem);var i=Ge(r,o,3);var a=t.offsetWidth/2;var l=t.offsetHeight/2;if(Fe(u.ctrl1)){t.style.left=u.ctrl1[0]-a+"px";t.style.top=u.ctrl1[1]-l+"px"}else{t.style.left=i("d1").x-a+"px";t.style.top=i("d1").y-l+"px";u.ctrl1=Ke(i("d1"))}if(Fe(u.ctrl2)){n.style.left=u.ctrl2[0]-a+"px";n.style.top=u.ctrl2[1]-l+"px"}else{n.style.left=i("d2").x-a+"px";n.style.top=i("d2").y-l+"px";u.ctrl2=Ke(i("d2"))}}function O(e){$();ot(v);var e=e||window.event;var t=e.target||e.srcElement;c=nt(f,t,lt.ndJs);c.relX=e.clientX-c.offsetLeft;c.relY=e.clientY-c.offsetTop;if(Fe(i)&&Xe(p)){s=i.deleteByNodeId(c.nodeid);me();pe();p=true}}function R(e){if(Ze(c)){c.style.cursor="move";c.style.left=e.clientX-c.relX+"px";c.style.top=e.clientY-c.relY+"px";pe()}}function F(){c=null;if(He(p)){i.addAll(s);s.clear();me();pe();p=false}}function W(e){var t=e.target;if(a.status===0){x.linkLineStart.call(this,a);a.setStart(t);me()}else if(a.status===1){var n=x.linkLineBefore.call(this,a);if(Xe(n)){return}a.setEnd(t);i.push(a);ge(a);x.linkLineAfter.call(this,a);a=new wt;ft(H,r)}}function q(e){pe(e)}function U(e){if(d!=e.target){return}var t=_(e);if(De(t)){u=t;var n=dt(f,e);K(t,n);x.clickLine.call(this,u)}else{$();ot(v)}pe()}function G(e){var t=_(e);if(De(t)){ft(H,r);ae("pointer");se(t)}else{ae("default");ft(H,r);ie()}}at.delegate(f,lt.inNdJs,"mousedown",C);at.delegate(f,lt.inNdJs,"mouseup",E);at.delegate(f,lt.inNdJs,"mouseover",B);at.delegate(f,lt.anchorJs,"mouseover",A);at.delegate(f,lt.anchorJs,"mouseout",P);at.delegate(f,lt.inNdJs,"mouseout",L);at.delegate(f,lt.anchorJs,"click",w);at.delegate(f,lt.menuDeleteJs,"click",Y);at.delegate(f,lt.menuEditJs,"click",V);at.delegate(f,lt.ctrlJs,"mousedown",b);at.delegate(f,lt.ctrlJs,"mouseup",T);at.on(f,"click",k);at.on(f,"mousemove",N);at.on(f,"contextmenu",I);at.on(f,"dragstart",j);function $(){u=null;ot(h("ctrl"))}function K(e,t){var n=v.getElementsByClassName(lt.menuBtnJs);rt(n);var r=Q(e,"lineType");switch(r){case"bezier":break;case"straight":var o=v.getElementsByClassName(lt.menuEditCss);ot(o);break;case"broken":var i=Q(e,"auto");if(He(i)){var o=v.getElementsByClassName(lt.menuEditCss);ot(o)};break}rt(v);v.style.left=t.x+"px";v.style.top=t.y+"px"}function Q(e,t){if(!De(e[t])){e[t]=g[t]}return e[t]}function Z(e){var t=e.pageX-d.getBoundingClientRect().left;var n=e.pageY-d.getBoundingClientRect().top;return{x:t,y:n}}function _(e){var t=null;if(le()){var n=Z(e);t=te(n.x,n.y)}return t}function ee(e){var t={};if(Ze(e)){t.y=e.parentNode.offsetTop+e.offsetTop+et(e)/2;t.x=e.parentNode.offsetLeft+e.offsetLeft+_e(e)/2}return t}function te(n,r){var o=null;i.forEach(function(e){var t=de(e,{x:n,y:r});if(t){o=e;return false}});return o}function ne(e,t,n){var r=Q(e,"lineType");var o=Q(e,"auto");if(r==="broken"&&He(o)){return re(t,n)}var i={};var a=Ge(t,n,3);i["d1Pos"]=$e(e.ctrl1);i["d2Pos"]=$e(e.ctrl2);if(!Fe(e.ctrl1)){i["d1Pos"]=a("d1")}if(!Fe(e.ctrl2)){i["d2Pos"]=a("d2")}return function(e){return i[e]}}function re(e,t){var n={};var r=(Oe(e.y)+Oe(t.y))/2;n["d1Pos"]=$e([e.x,r]);n["d2Pos"]=$e([t.x,r]);return function(e){return n[e]}}function oe(e){var t=l.getNodeById(e.startNodeid);var n=l.getNodeById(e.endNodeid);var r=t.childNodes;var o=n.childNodes;var i=pt(r,e.startAnchorid);var a=pt(o,e.endAnchorid);return{startElem:i,endElem:a}}function ie(){if(De(u)){se(u)}}function ae(e){f.style.cursor=e}function le(){return Fe(i)||Fe(s)}function se(e){var t=ee(e.startElem);var n=ee(e.endElem);var r=Q(e,"lineType");switch(r){case"bezier":var o=ne(e,t,n);ue(H,e,t,o("d1Pos"),o("d2Pos"),n);break;case"straight":fe(H,e,t,n);break;case"broken":var i=ne(e,t,n);ce(H,e,t,i("d1Pos"),i("d2Pos"),n);break}}function ce(e,t,n,r,o,i){e.save();e.beginPath();e.lineCap="round";e.lineWidth=X;e.strokeStyle=g.lineHoverColor;e.moveTo(n.x,n.y);e.lineTo(r.x,r.y);e.lineTo(o.x,o.y);e.lineTo(i.x,i.y);e.stroke();e.restore()}function ue(e,t,n,r,o,i){var a=0;var l=Q(t,"lineStyle");var s=l==="arrow";var c=je(Me(o.x-i.x,2)+Me(o.y-i.y,2));var u=(a+10)/c;var f=a/c;var d={};d.x=i.x+f*(o.x-i.x);d.y=i.y+f*(o.y-i.y);var v={};v.x=s?i.x+u*(o.x-i.x):i.x;v.y=s?i.y+u*(o.y-i.y):i.y;e.save();e.beginPath();e.lineCap="round";e.lineWidth=X;e.strokeStyle=g.lineHoverColor;e.moveTo(n.x,n.y);e.bezierCurveTo(r.x,r.y,o.x,o.y,v.x,v.y);e.stroke();e.restore()}function fe(e,t,n,r){e.save();e.beginPath();e.lineCap="round";e.lineWidth=X;e.strokeStyle=g.lineHoverColor;e.moveTo(n.x,n.y);e.lineTo(r.x,r.y);e.stroke();e.restore()}function de(e,t){var n=false;var r=ee(e.startElem);var o=ee(e.endElem);var i=Q(e,"lineType");switch(i){case"bezier":var a=ne(e,r,o);n=he(r,a("d1Pos"),a("d2Pos"),o,t);break;case"straight":n=ye(r,o,t);break;case"broken":var l=ne(e,r,o);n=ve(r,l("d1Pos"),l("d2Pos"),o,t);break}return n}function ve(e,t,n,r,o){return ye(e,t,o)||ye(t,n,o)||ye(n,r,o)}function he(e,t,n,r,o){var i=10;var a=X/2;var l=0;var s=Ie((t.y-e.y)/(t.x-e.x));var c=Ie((r.y-n.y)/(r.x-n.x));var u=e.x-a*Pe(s)+i*Se(s);var f=e.y+a*Se(s)+i*Pe(s);var d=t.x-a*Pe(s);var v=t.y+a*Se(s);var h=n.x-a*Pe(c);var y=n.y+a*Se(c);var m=r.x-a*Pe(c)-i*Se(c);var p=r.y+a*Se(c)-i*Pe(c);var g=je(Me(h-m,2)+Me(y-p,2));var x=(l+10)/g;var w=l/g;var C=m+w*(h-m);var E=p+w*(y-p);var T=m+x*(h-m);var b=p+x*(y-p);H.save();H.beginPath();H.moveTo(u,f);H.bezierCurveTo(d,v,h,y,T,b);var k=e.x+a*Pe(s)+i*Se(s);var N=e.y-a*Se(s)+i*Pe(s);var B=t.x+a*Pe(s);var L=t.y-a*Se(s);var J=n.x+a*Pe(c);var A=n.y-a*Se(c);var P=r.x+a*Pe(c)-i*Se(c);var S=r.y-a*Se(c)-i*Pe(c);var I=je(Me(J-P,2)+Me(A-S,2));var j=(l+10)/I;var w=l/I;var C=P+w*(J-P);var E=S+w*(A-S);var M=P+j*(J-P);var D=S+j*(A-S);H.lineTo(T,b);H.lineTo(M,D);H.lineTo(M,D);H.bezierCurveTo(J,A,B,L,k,N);H.moveTo(k,N);H.lineTo(u,f);H.restore();return H.isPointInPath(o.x,o.y)}function ye(e,t,n){var r=X/2;var o=10;var i=Ie((t.y-e.y)/(t.x-e.x));var a=e.x+r*Pe(i)+o*Se(i);var l=e.y-r*Se(i)+o*Pe(i);var s=e.x-r*Pe(i)+o*Se(i);var c=e.y+r*Se(i)+o*Pe(i);var u=t.x-r*Pe(i)-o*Se(i);var f=t.y+r*Se(i)-o*Pe(i);var d=t.x+r*Pe(i)-o*Se(i);var v=t.y-r*Se(i)-o*Pe(i);H.save();H.beginPath();H.moveTo(a,l);H.lineTo(s,c);H.lineTo(u,f);H.lineTo(d,v);H.closePath();H.restore();return H.isPointInPath(n.x,n.y)}function me(){ft(o,d);i.forEach(function(e){we(o,e)})}function pe(e){ft(H,r);if(a.status!==0){xe(e)}s.forEach(function(e){we(H,e)});ie()}function ge(e){we(o,e)}function xe(e){var t=ee(a.startElem);var n=dt(d,e);Ce(H,a,t,n)}function we(e,t){if(!Ze(t.startElem)||!Ze(t.endElem)){var n=oe(t);t.startElem=n["startElem"];t.endElem=n["endElem"]}var r=ee(t.startElem);var o=ee(t.endElem);Ce(e,t,r,o)}function Ce(e,t,n,r){var o=Q(t,"lineType");switch(o){case"bezier":var i=ne(t,n,r);Ee(e,t,n,i("d1Pos"),i("d2Pos"),r,0);break;case"straight":be(e,t,n,r);break;case"broken":var a=ne(t,n,r);ke(e,t,n,a("d1Pos"),a("d2Pos"),r)}}function Ee(e,t,n,r,o,i,a){var l=Q(t,"lineStyle");var s=l==="arrow";var c=je(Me(o.x-i.x,2)+Me(o.y-i.y,2));var u=(a+10)/c;var f=a/c;var d={};d.x=i.x+f*(o.x-i.x);d.y=i.y+f*(o.y-i.y);var v={};v.x=s?i.x+u*(o.x-i.x):i.x;v.y=s?i.y+u*(o.y-i.y):i.y;e.save();e.beginPath();if(e!==H){e.strokeStyle=g.lineColor}else{e.strokeStyle=g.lineActiveColor}e.moveTo(n.x,n.y);e.bezierCurveTo(r.x,r.y,o.x,o.y,v.x,v.y);e.stroke();e.beginPath();e.arc(i.x,i.y,a,0,2*Math.PI);e.stroke();s&&Ne(e,o,d,v);e.restore()}function Te(e,t,n,r){e.beginPath();e.translate(n.x,n,y);e.rotate(Math.atan2(r.y-t.y,r.x-t.x));e.moveTo(0,0);e.lineTo(-10,3);e.lineTo(-10,-3);e.lineTo(0,0);e.stroke();e.fill()}function be(e,t,n,r){if(e!==H){e.strokeStyle=g.lineColor}else{e.strokeStyle=g.lineActiveColor}e.save();e.beginPath();e.moveTo(n.x,n.y);e.lineTo(r.x,r.y);e.stroke();var o=Q(t,"lineStyle");if(o=="arrow"){Ne(e,n,r)}e.restore()}function ke(e,t,n,r,o,i){e.save();e.beginPath();if(e!==H){e.strokeStyle=g.lineColor}else{e.strokeStyle=g.lineActiveColor}e.moveTo(n.x,n.y);e.lineTo(r.x,r.y);e.lineTo(o.x,o.y);e.lineTo(i.x,i.y);e.stroke();var a=Q(t,"lineStyle");if(a=="arrow"){Ne(e,o,i)}e.restore()}function Ne(e,t,n){e.save();e.beginPath();e.translate(n.x,n.y);e.rotate(Math.atan2(n.y-t.y,n.x-t.x));e.lineTo(-10,3);e.lineTo(-10,-3);e.lineTo(0,0);e.fillStyle=g.arrowColor;e.fill()}function Be(e){Ve(e).forEach(function(e){var t=e.getElementsByTagName("img");Ve(t).forEach(function(e){if(Ze(e)){var t=e.getBoundingClientRect();var n=f.getBoundingClientRect();o.drawImage(e,t.x-n.x,t.y-n.y,t.width,t.height)}})})}this.addNode=function(e){var t=document.createElement("div");tt(t,[lt.ndCss,lt.ndJs]);t.style.left=e.pos.x+"px";t.style.top=e.pos.y+"px";if(Ze(e.template)){t.appendChild(e.template);t.template=e.template.outerHTML}else{t.innerHTML=e.template;t.template=e.template}t.nodeid=isNaN(e.nodeid)?null:e.nodeid;t.anchors=e.anchors;var n=t.children[0];tt(n,lt.inNdJs);f.appendChild(t);var r=l.push(t);r.setAttribute("node-id",r.nodeid);n.nodeid=t.nodeid;var o=ht(t);ot(o,true);return t};var Le=Ue("deleteLineBefore,deleteLineAfter,linkLineStart,linkLineBefore,linkLineAfter,clickLine",false);this.listen=function(){if(arguments.length===1&&Re(arguments[0])){x=We(arguments[0],x)}else if(arguments.length>=2&&ze(arguments[1])){var e=arguments[0],t=arguments[1];if(Le(e)){x[e]=t}}};this.getAllNodes=function(){return l.toArray()};this.getAllLines=function(){return i.fiterData()};this.getAllNodesInfo=function(){return l.fiterData()};this.deleteNodeById=function(){var r=[];Ve(arguments).forEach(function(e){var t=Oe(e);i.deleteByNodeId(t);var n=l.deleteById(t);r.push(n);me();pe()});return r};this.clear=function(){while(l.length){var e=l.peek();i.deleteByNodeId(e.nodeid);l.deleteById(e.nodeid)}me();pe()};this.init=function(e,t){if(!Ye(e)||!Ye(t)){Qe("unknown arguments in init(nodeStack,lineStack)")}l.clear();for(var n=0;n<e.length;n++){var r=e[n];this.addNode(r)}i.clear();i.addAll(t);me()};this.setDisabled=function(e){if(De(e)){n=Boolean(e)}};this.getImage=function(r,o){var i=_e(f),a=et(f),l=new Image,s=document.createElement("canvas"),c=s.getContext("2d"),e=f.getElementsByClassName(lt.ndJs),u=new Image;s.width=i;s.height=a;Be(e);it(function(e){var t=st(e);var n=ct(f,t,s);u.src=n;u.onload=function(){c.drawImage(u,0,0,i,a);l.src=d.toDataURL("image/png");if(ze(r)){r(l)}if(He(o)){l.onload=function(){c.drawImage(l,0,0,i,a);var e=document.createElement("a");e.download="drawtool-"+Je+"-"+(new Date).getTime()+".png";e.href=s.toDataURL("image/png");e.click()}}}})}}h.prototype.version=Je;return h});