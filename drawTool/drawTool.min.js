/*!
 * drawTool.js v1.2.0
 * (c) fwx426328
 */
(function(b,a){typeof exports==="object"&&typeof module!=="undefined"?module.exports=a():typeof define==="function"&&define.amd?define(a):typeof define==="function"&&define.cmd?define(a):(b.DrawTool=a())})(this,function(){var ac="1.2.0";var O=Object.prototype;var l=Array.prototype;var K=O.toString;var o=O.hasOwnProperty;var t=new Function();function s(ah){return Math.sin(ah)}function i(ah){return Math.cos(ah)}function T(ah){return Math.tant(ah)}function N(ah){return Math.atan(ah)}function Q(ah){return Math.sqrt(ah)}function L(ai,ah){return Math.pow(ai,ah)}function M(ah){return ah!==undefined&&ah!==null}function U(ah){return ah===true}function m(ah){return ah===false}function A(ah){return K.call(ah)==="[object Function]"}function G(ah){return K.call(ah)==="[object Array]"}function z(ah){return l.slice.call(ah)}function ab(ah){var ai=parseFloat(ah);return isNaN(ai)?ah:ai}function R(ah){return ah!==null&&typeof ah==="object"}function d(ah){return ah&&ah.length>0}function h(ah,ai){return o.call(ah,ai)}function b(ai,ah){var aj;for(aj in ai){if(h(ai,aj)){if(ah(ai[aj],aj)){break}}}}function ag(aj,ai,ah){if(ai){b(ai,function(ak,al){if(U(ah)||!h(aj,al)){aj[al]=ak}})}return aj}function D(ah){ah=ag(ah,{before:t,fun:t,after:t});return function(){ah.before.apply(ah.func,arguments);ah.fun.apply(ah.func,arguments);ah.after.apply(ah.func,arguments)}}function V(al,ah){var ak=Object.create(null);var aj=al.split(",");for(var ai=0;ai<aj.length;ai++){ak[aj[ai]]=true}return ah?function(am){am=am||"";return ak[am.toLowerCase()]}:function(am){return ak[am]}}function E(an,aj,ak){var am={};var ah=(aj.x-an.x)/ak;var ap=(aj.y-an.y)/ak;for(var ai=0;ai<=ak;ai++){var ao=an.x+ai*ah;var al=an.y+ai*ap;am["d"+ai]={x:ao,y:al}}return function(aq){return am[aq]}}function j(ah){var ai={};if(G(ah)){ai={x:ah[0],y:ah[1]}}return ai}function k(ai){var ah=[];if(R(ai)){ah[0]=ai.x;ah[1]=ai.y}return ah}function I(ah){throw new Error("drawTool.js error: "+ah)}function Z(ah){return !!(ah&&ah.nodeType)}function aa(ah){return ah.offsetWidth}function w(ah){return ah.offsetHeight}function W(ai,ah){var aj=" ";return(aj+ai.className+aj).indexOf(aj+ah+aj)>-1}function F(ai,ah){if(G(ah)){ah.forEach(function(aj){F(ai,aj)})}else{if(!ai.className){ai.className=ah}else{ai.className=ai.className+" "+ah}}return ai}function x(ak,ah){if(W(ak,ah)){var ai=" ";var aj=ai+ak.className.replace(/[\t\r\n]/g,"")+ai;while(aj.indexOf(ai+ah+ai)>=0){aj=aj.replace(ai+ah+ai,ai)}ak.className=aj.replace(/^\s+|\s+$/g,"")}return ak}function H(ai,aj,ah){if(ai==aj){return null}if(W(aj,ah)){return aj}else{return H(ai,aj.parentNode,ah)}}function P(ah,ai){if(Z(ah)){if(U(ai)){!W(ah,Y.showVisCss)&&F(ah,Y.showVisCss);W(ah,Y.hideVisCss)&&x(ah,Y.hideVisCss)}else{!W(ah,Y.showCss)&&F(ah,Y.showCss);W(ah,Y.hideCss)&&x(ah,Y.hideCss)}}else{z(ah).forEach(function(aj){P(aj,ai)})}return ah}function g(ah,ai){if(Z(ah)){if(U(ai)){!W(ah,Y.hideVisCss)&&F(ah,Y.hideVisCss);W(ah,Y.showVisCss)&&x(ah,Y.showVisCss)}else{!W(ah,Y.hideCss)&&F(ah,Y.hideCss);W(ah,Y.showCss)&&x(ah,Y.showCss)}}else{z(ah).forEach(function(aj){g(aj,ai)})}return ah}var S=new Object();S.on=function(aj,ai,ah){if(aj.addEventListener){S.on=function(am,al,ak){am.addEventListener(al,ak,false)}}else{S.on=function(am,al,ak){am.attachEvent("on"+al,ak)}}S.on(aj,ai,ah)};S.delegate=function(ah,ak,aj,ai){S.on(ah,aj,function(an){var an=an||window.event;var am=an.target||an.srcElement;var al=H(ah,am,ak);if(al){ai.call(al,an)}},false)};S.off=function(aj,ai,ah){if(aj.removeEventListener){S.off=function(am,al,ak){am.removeEventListener(al,ak,false)}}else{S.off=function(am,al,ak){am.detachEvent("on"+al,ak)}}S.off(aj,ai,ah)};var Y={showCss:"drawTool-show",hideCss:"drawTool-hide",showVisCss:"drawTool-visibility-show",hideVisCss:"drawTool-visibility-hide",rootCss:"drawTool-content-root",ndCss:"drawTool-node",ndJs:"js-drawTool-node",inNdJs:"js-drawTool-inner-node",anchorCss:"drawTool-anchor",anchorJs:"js-drawTool-anchor",menuCss:"drawTool-operate",menuBtnCss:"drawTool-operate-btn",menuBtnJs:"js-drawTool-operate-btn",menuDeleteCss:"drawTool-operate-delete",menuDeleteJs:"js-drawTool-operate-delete",menuEditJs:"js-drawTool-operate-edit",menuEditCss:"drawTool-operate-edit",controller:"drawTool-controller",ctrlli:"drawTool-controller-li",ctrlJs:"js-drawTool-controller-li",cvs:"drawTool-canvas",bgCvs:"drawTool-background-canvas",avCvs:"drawTool-active-canvas"};function c(ai){var ah=document.createElement("canvas");ah.width=aa(ai);ah.height=w(ai);ai.appendChild(ah);return ah}function q(ah,ai){ah.clearRect(0,0,aa(ai),w(ai))}function B(ai){var ak=window.event||ai;var al=document.documentElement.scrollLeft||document.body.scrollLeft;var aj=document.documentElement.scrollTop||document.body.scrollTop;var ah=ak.pageX||ak.clientX+al;var am=ak.pageY||ak.clientY+aj;return{x:ah,y:am}}function X(am,al){var ai=B(al);var aj=am.getBoundingClientRect();var an=document.documentElement.scrollLeft||document.body.scrollLeft;var ak=document.documentElement.scrollTop||document.body.scrollTop;var ah=aj.left+an;
var ao=aj.top+ak;return{x:(ai.x-ah),y:(ai.y-ao)}}function f(ah){b(ah,function(ai,aj){if(aj.indexOf("Js")>-1){ah[aj]+="-"+Math.floor(Math.random()*new Date().getTime())}})}function n(ai){var ah=[];if(G(ai.anchors)){ai.anchors.forEach(function(al,ak){var aj=document.createElement("span");F(aj,[Y.anchorCss,Y.anchorJs]);aj.anchorid=ak;aj.pos=[al[0],al[1]];aj.setAttribute("anchorNode-id",ak);ai.appendChild(aj);ah.push(aj);aj.style.left=al[0]-aa(aj)/2+"px";aj.style.top=al[1]-w(aj)/2+"px"})}return ah}function u(ah){var ai=document.createElement("div");ai.className=Y.menuCss;ai.innerHTML='		<span class="'+Y.menuBtnCss+" "+Y.menuDeleteCss+" "+Y.menuBtnJs+'">			<i class="'+Y.menuDeleteJs+'"></i>		</span>		<span class="'+Y.menuBtnCss+" "+Y.menuEditCss+" "+Y.menuBtnJs+'">			<i class="'+Y.menuEditJs+'"></i>		</span>';ah.appendChild(ai);return g(ai)}function af(ak){var aj=document.createElement("ul");aj.className=Y.controller;var ai=document.createElement("li");ai.className=Y.ctrlli+" "+Y.ctrlJs;ai.ctrlFlag=1;var ah=document.createElement("li");ah.className=Y.ctrlli+" "+Y.ctrlJs;ah.ctrlFlag=2;aj.appendChild(ai);aj.appendChild(ah);ak.appendChild(aj);g(aj);var al={ctrl1:ai,ctrl2:ah,ctrl:aj};return function(am){return al[am]}}function ae(ai,ah){var aj=null;ai.forEach(function(ak){if(W(ak,Y.anchorJs)){if(ak.anchorid==ah){aj=ak;return false}}});return aj}function J(){this.length=0}var p=J.prototype;p.pop=l.pop;p.forEach=l.forEach;p.peek=function(){return this.length>0?this[this.length-1]:undefined};p.push=function(ai){var ah=0;this.forEach(function(aj){if(aj.nodeid>ah){ah=aj.nodeid}});ai.nodeid=ai.nodeid||(Number(ah)+1);l.push.call(this,ai);return ai};p.getNodeById=function(aj){var ai=null;for(var ah=0;ah<this.length;ah++){var ak=this[ah];if(ak.nodeid==aj){ai=ak;break}}return ai};p.deleteById=function(aj){var ai=null;for(var ah=0;ah<this.length;ah++){var ak=this[ah];if(ak.nodeid==aj){ak.remove();l.splice.call(this,ah,1);break}}return ai};p.clear=function(){for(var ah=0;ah<this.length;ah++){this[ah].remove()}this.length=0};p.toArray=function(){var ah=[];for(var ai=0;ai<this.length;ai++){ah.push(this[ai])}return ah};p.fiterData=function(){var aj=[];for(var ah=0;ah<this.length;ah++){var ai=this[ah];var al=ab(ai.style.left);var ak=ab(ai.style.top);var am={html:ai.htmlStr.replace(/[\r\n\t]/g,""),nodeid:ai.nodeid,pos:{x:al,y:ak},anchors:ai.anchors};aj.push(am)}return aj};function r(){this.length=0}var ad=r.prototype;ad.pop=l.pop;ad.forEach=l.forEach;ad.peek=function(){return this.length>0?this[this.length-1]:undefined};ad.push=function(ah){var aj=0;for(var ai=0;ai<this.length;ai++){if(this[ai].lineid>aj){aj=this[ai].lineid}}ah.lineid=ah.lineid||(aj+1);l.push.call(this,ah);return ah};ad.addAll=function(ai){var ah=this;ai.forEach(function(aj){ah.push(aj)});return ah};ad.deleteById=function(aj){var ai=new r();for(var ah=0;ah<this.length;ah++){if(this[ah].lineid==aj){ai.push(this[ah]);l.splice.call(this,ah,1);break}}return ai};ad.deleteByNodeId=function(aj){var ai=new r();for(var ah=0;ah<this.length;ah++){if(this[ah].startNodeid==aj||this[ah].endNodeid==aj){ai.push(this[ah]);l.splice.call(this,ah,1);ah--}}return ai};ad.getLineById=function(ak){var ah=null;for(var aj=0;aj<this.length;aj++){var ai=this[aj];if(ai.lineid==ak){ah=ai;break}}return ah};ad.toArray=function(){var ah=[];for(var ai=0;ai<this.length;ai++){ah.push(this[ai])}return ah};ad.fiterData=function(){var ak=[];for(var aj=0;aj<this.length;aj++){var ah=this[aj];var ai={lineid:ah.lineid,startNodeid:ah.startNodeid,startAnchorid:ah.startAnchorid,endNodeid:ah.endNodeid,endAnchorid:ah.endAnchorid,ctrl1:ah.ctrl1,ctrl2:ah.ctrl2,type:ah.type,style:ah.style,auto:ah.auto};ak.push(ai)}return ak};ad.clear=function(){while(this.length){this.pop()}};var a=V("broken,bezier,straight",true);var v=V("arrow,none",true);function e(){this.lineid=null;this.startNodeid=null;this.startAnchorid=null;this.startElem=null;this.endNodeid=null;this.endAnchorid=null;this.endElem=null;this.ctrl1=[];this.ctrl2=[];this.type=null;this.status=0;this.lineStyle=null;this.auto=null}e.prototype.setType=function(ah){if(a(ah)){this.type=ah}return this};e.prototype.setStyle=function(ah){if(v(ah)){this.lineStyle=ah}return this};e.prototype.setAuto=function(ah){this.auto=!!ah;return this};e.prototype.setStart=function(ah){this.startNodeid=ah.parentNode.nodeid;this.startAnchorid=ah.anchorid;this.startElem=ah;this.status=1;return this};e.prototype.setEnd=function(ah){this.endNodeid=ah.parentNode.nodeid;this.endAnchorid=ah.anchorid;this.endElem=ah;this.status=2;return this};function C(av,bi){if(!Z(av)){I(av+" is not dom");return}f(Y);var aA=av;var bh=c(aA);var ak=bh.getContext("2d");var at=c(aA);var aT=at.getContext("2d");var ax=new J();var bd=new r();var ay=new e();var bo=new r();var bg=null;var aV=5;var ai=null;var aB=u(aA);var aH=af(aA);var bt=null;var bn=false;!R(bi)&&(bi={});var bu=ag(bi,{lineColor:"#26b7d0",lineHoverColor:"rgba(200, 200, 200, 0.4)",lineActiveColor:"#2177C7",arrowColor:"#444",lineStyle:"arrow",type:"bezier",auto:true});
var aW={clickLine:t,deleteLineBefore:function aO(){return true},deleteLineAfter:t,linkLineStart:t,linkLineBefore:function al(){return true},linkLineAfter:t};F(aA,Y.rootCss);F(at,[Y.cvs,Y.bgCvs]);F(bh,[Y.cvs,Y.avCvs]);var aY=D({before:function(){if(ay.status===0){S.on(aA,"mousemove",bb)}},fun:ba,after:function(){if(ay.status===0){S.off(aA,"mousemove",bb)}}});var a9=D({fun:aq,after:function(){S.on(aA,"mousemove",a1)}});var aM=D({fun:ao,after:function(){S.off(aA,"mousemove",a1)}});var bm=D({fun:am,after:function(){S.off(aA,"mousemove",aK)}});var aQ=D({fun:bp,after:function(){S.on(aA,"mousemove",aK)}});function ap(bx){var bw=H(aA,bx.target,Y.ndJs);clearTimeout(bw.hideTimer);var bv=bw.getElementsByClassName(Y.anchorJs);P(bv,true)}function a8(bx){var bw=H(aA,bx.target,Y.ndJs);var bv=bw.getElementsByClassName(Y.anchorJs);bw.hideTimer=setTimeout(function(){g(bv,true)},300)}function a0(bv){ay=new e();aE();ah();bv.preventDefault()}function bp(bv){bt=bv.target;bt.relX=bv.clientX-bt.offsetLeft;bt.relY=bv.clientY-bt.offsetTop;if(d(bd)&&m(bn)&&M(ai)){bo=bd.deleteById(ai.lineid);aN();ah();bn=true;console.log("提取")}}function am(){if(U(bn)){bd.addAll(bo);bo.clear();aN();ah();bn=false;console.log("投放")}}function aK(bx){if(Z(bt)){var bw=bx.clientX-bt.relX;var bz=bx.clientY-bt.relY;bt.style.left=bw+"px";bt.style.top=bz+"px";var bv=bw+bt.offsetWidth/2;var by=bz+bt.offsetHeight/2;ai["ctrl"+bt.ctrlFlag]=[bv,by];ah()}}function bc(){var bv=aW.deleteLineBefore.call(this,ai);if(m(bv)){return}bd.deleteById(ai.lineid);aW.deleteLineAfter.call(this,ai);aE();g(aB);aN();ah()}function au(bB){P(aH("ctrl"));g(aB);var bw=aH("ctrl1");var bC=aH("ctrl2");var by=aw(ai.startElem);var bv=aw(ai.endElem);var bz=E(by,bv,3);var bA=bw.offsetWidth/2;var bx=bw.offsetHeight/2;if(d(ai.ctrl1)){bw.style.left=ai.ctrl1[0]-bA+"px";bw.style.top=ai.ctrl1[1]-bx+"px"}else{bw.style.left=bz("d1").x-bA+"px";bw.style.top=bz("d1").y-bx+"px";ai.ctrl1=k(bz("d1"))}if(d(ai.ctrl2)){bC.style.left=ai.ctrl2[0]-bA+"px";bC.style.top=ai.ctrl2[1]-bx+"px"}else{bC.style.left=bz("d2").x-bA+"px";bC.style.top=bz("d2").y-bx+"px";ai.ctrl2=k(bz("d2"))}}function aq(bw){aE();g(aB);var bw=bw||window.event;var bv=bw.target||bw.srcElement;bg=H(aA,bv,Y.ndJs);bg.relX=bw.clientX-bg.offsetLeft;bg.relY=bw.clientY-bg.offsetTop;if(d(bd)&&m(bn)){bo=bd.deleteByNodeId(bg.nodeid);aN();ah();bn=true;console.log("提取")}}function a1(bv){if(Z(bg)){bg.style.cursor="move";bg.style.left=bv.clientX-bg.relX+"px";bg.style.top=bv.clientY-bg.relY+"px";ah()}}function ao(){bg=null;if(U(bn)){bd.addAll(bo);bo.clear();aN();ah();bn=false;console.log("投放")}}function ba(bx){var bv=bx.target;if(ay.status===0){aW.linkLineStart.call(this,ay);ay.setStart(bv);aN()}else{if(ay.status===1){var bw=aW.linkLineBefore.call(this,ay);if(m(bw)){return}ay.setEnd(bv);bd.push(ay);bk(ay);aW.linkLineAfter.call(this,ay);ay=new e();q(ak,bh)}}}function bb(){ah()}function bs(bw){if(at!=bw.target){return}var bv=be(bw);if(M(bv)){console.log("点击线条");ai=bv;var bx=X(aA,bw);aC(bv,bx);aW.clickLine.call(this,ai)}else{console.log("点击非线条");aE();g(aB)}ah()}function a4(bw){var bv=be(bw);if(M(bv)){q(ak,bh);bl("pointer");a7(bv)}else{bl("default");q(ak,bh);bf()}}S.delegate(aA,Y.inNdJs,"mousedown",a9);S.delegate(aA,Y.inNdJs,"mouseup",aM);S.delegate(aA,Y.inNdJs,"mouseover",ap);S.delegate(aA,Y.inNdJs,"mouseout",a8);S.delegate(aA,Y.anchorJs,"click",aY);S.delegate(aA,Y.menuDeleteJs,"click",bc);S.delegate(aA,Y.menuEditJs,"click",au);S.delegate(aA,Y.ctrlJs,"mousedown",aQ);S.delegate(aA,Y.ctrlJs,"mouseup",bm);S.on(aA,"click",bs);S.on(aA,"mousemove",a4);S.on(aA,"contextmenu",a0);function aE(){ai=null;g(aH("ctrl"))}function aC(bx,bA){var bw=aB.getElementsByClassName(Y.menuBtnJs);P(bw);var bz=aX(bx,"type");switch(bz){case"bezier":break;case"straight":var by=aB.getElementsByClassName(Y.menuEditCss);g(by);break;case"broken":var bv=aX(bx,"auto");if(U(bv)){var by=aB.getElementsByClassName(Y.menuEditCss);g(by)}break}P(aB);aB.style.left=bA.x+"px";aB.style.top=bA.y+"px"}function aX(bv,bw){if(!M(bv[bw])){bv[bw]=bu[bw]}return bv[bw]}function aZ(bw){var bv=bw.pageX-at.getBoundingClientRect().left;var bx=bw.pageY-at.getBoundingClientRect().top;return{x:bv,y:bx}}function be(bw){var bv=null;if(aD()){var bx=aZ(bw);bv=ar(bx.x,bx.y)}return bv}function aw(bv){var bw={};if(Z(bv)){bw.y=bv.parentNode.offsetTop+bv.offsetTop+w(bv)/2;bw.x=bv.parentNode.offsetLeft+bv.offsetLeft+aa(bv)/2}return bw}function ar(bv,bx){var bw=null;bd.forEach(function(by){var bz=aJ(by,{x:bv,y:bx});if(bz){bw=by;return false}});return bw}function aG(bw,by,bv){var bz=aX(bw,"type");var bB=aX(bw,"auto");if(bz==="broken"&&U(bB)){return aF(by,bv)}var bx={};var bA=E(by,bv,3);bx["d1Pos"]=j(bw.ctrl1);bx["d2Pos"]=j(bw.ctrl2);if(!d(bw.ctrl1)){bx["d1Pos"]=bA("d1")}if(!d(bw.ctrl2)){bx["d2Pos"]=bA("d2")}return function(bC){return bx[bC]}}function aF(by,bv){var bx={};var bw=(ab(by.y)+ab(bv.y))/2;bx["d1Pos"]=j([by.x,bw]);bx["d2Pos"]=j([bv.x,bw]);return function(bz){return bx[bz]}}function bj(bx){var bw=ax.getNodeById(bx.startNodeid);var by=ax.getNodeById(bx.endNodeid);
var bB=bw.childNodes;var bz=by.childNodes;var bA=ae(bB,bx.startAnchorid);var bv=ae(bz,bx.endAnchorid);return{startElem:bA,endElem:bv}}function bf(){if(M(ai)){a7(ai)}}function bl(bv){aA.style.cursor=bv}function aD(){return d(bd)||d(bo)}function a7(bw){var bx=aw(bw.startElem);var bv=aw(bw.endElem);var bz=aX(bw,"type");switch(bz){case"bezier":var bA=aG(bw,bx,bv);aj(ak,bw,bx,bA("d1Pos"),bA("d2Pos"),bv);break;case"straight":aR(ak,bw,bx,bv);break;case"broken":var by=aG(bw,bx,bv);aI(ak,bw,bx,by("d1Pos"),by("d2Pos"),bv);break}}function aI(bx,bw,by,bA,bz,bv){bx.save();bx.beginPath();bx.lineCap="round";bx.lineWidth=aV;bx.strokeStyle=bu.lineHoverColor;bx.moveTo(by.x,by.y);bx.lineTo(bA.x,bA.y);bx.lineTo(bz.x,bz.y);bx.lineTo(bv.x,bv.y);bx.stroke();bx.restore()}function aj(bG,bI,bF,bz,bv,bB){var by=0;var bC=aX(bI,"lineStyle");var bE=(bC==="arrow");var bx=Q(L((bv.x-bB.x),2)+L((bv.y-bB.y),2));var bA=(by+10)/bx;var bH=by/bx;var bw={};bw.x=bB.x+bH*(bv.x-bB.x);bw.y=bB.y+bH*(bv.y-bB.y);var bD={};bD.x=bE?bB.x+bA*(bv.x-bB.x):bB.x;bD.y=bE?bB.y+bA*(bv.y-bB.y):bB.y;bG.save();bG.beginPath();bG.lineCap="round";bG.lineWidth=aV;bG.strokeStyle=bu.lineHoverColor;bG.moveTo(bF.x,bF.y);bG.bezierCurveTo(bz.x,bz.y,bv.x,bv.y,bD.x,bD.y);bG.stroke();bG.restore()}function aR(bx,bw,by,bv){bx.save();bx.beginPath();bx.lineCap="round";bx.lineWidth=aV;bx.strokeStyle=bu.lineHoverColor;bx.moveTo(by.x,by.y);bx.lineTo(bv.x,bv.y);bx.stroke();bx.restore()}function aJ(bw,bC){var by=false;var bx=aw(bw.startElem);var bv=aw(bw.endElem);var bA=aX(bw,"type");switch(bA){case"bezier":var bB=aG(bw,bx,bv);by=an(bx,bB("d1Pos"),bB("d2Pos"),bv,bC);break;case"straight":by=aU(bx,bv,bC);break;case"broken":var bz=aG(bw,bx,bv);by=az(bx,bz("d1Pos"),bz("d2Pos"),bv,bC);break}return by}function az(bw,by,bx,bv,bz){return aU(bw,by,bz)||aU(by,bx,bz)||aU(bx,bv,bz)}function an(bN,by,bL,bV,bR){var bI=10;var b3=aV/2;var bK=0;var bZ=N((by.y-bN.y)/(by.x-bN.x));var bY=N((bV.y-bL.y)/(bV.x-bL.x));var bP=bN.x-b3*s(bZ)+bI*i(bZ);var bC=bN.y+b3*i(bZ)+bI*s(bZ);var bJ=by.x-b3*s(bZ);var bz=by.y+b3*i(bZ);var bG=bL.x-b3*s(bY);var b5=bL.y+b3*i(bY);var bB=bV.x-b3*s(bY)-bI*i(bY);var b1=bV.y+b3*i(bY)-bI*s(bY);var bU=Q(L((bG-bB),2)+L((b5-b1),2));var bx=(bK+10)/bU;var bQ=bK/bU;var bF=bB+bQ*(bG-bB);var bE=b1+bQ*(b5-b1);var b4=bB+bx*(bG-bB);var bS=b1+bx*(b5-b1);ak.save();ak.beginPath();ak.moveTo(bP,bC);ak.bezierCurveTo(bJ,bz,bG,b5,b4,bS);var bH=bN.x+b3*s(bZ)+bI*i(bZ);var bw=bN.y-b3*i(bZ)+bI*s(bZ);var bD=by.x+b3*s(bZ);var b2=by.y-b3*i(bZ);var bA=bL.x+b3*s(bY);var bX=bL.y-b3*i(bY);var bv=bV.x+b3*s(bY)-bI*i(bY);var bT=bV.y-b3*i(bY)-bI*s(bY);var bO=Q(L((bA-bv),2)+L((bX-bT),2));var b0=(bK+10)/bO;var bQ=bK/bO;var bF=bv+bQ*(bA-bv);var bE=bT+bQ*(bX-bT);var bW=bv+b0*(bA-bv);var bM=bT+b0*(bX-bT);ak.lineTo(b4,bS);ak.lineTo(bW,bM);ak.lineTo(bW,bM);ak.bezierCurveTo(bA,bX,bD,b2,bH,bw);ak.moveTo(bH,bw);ak.lineTo(bP,bC);ak.restore();return ak.isPointInPath(bR.x,bR.y)}function aU(bH,bC,bG){var bD=aV/2;var bz=10;var by=N((bC.y-bH.y)/(bC.x-bH.x));var bx=bH.x+bD*s(by)+bz*i(by);var bw=bH.y-bD*i(by)+bz*s(by);var bF=bH.x-bD*s(by)+bz*i(by);var bE=bH.y+bD*i(by)+bz*s(by);var bB=bC.x-bD*s(by)-bz*i(by);var bA=bC.y+bD*i(by)-bz*s(by);var bv=bC.x+bD*s(by)-bz*i(by);var bI=bC.y-bD*i(by)-bz*s(by);ak.save();ak.beginPath();ak.moveTo(bx,bw);ak.lineTo(bF,bE);ak.lineTo(bB,bA);ak.lineTo(bv,bI);ak.closePath();ak.restore();return ak.isPointInPath(bG.x,bG.y)}function aN(){q(aT,at);bd.forEach(function(bv){bq(aT,bv)})}function ah(){q(ak,bh);if(ay.status!==0){a5()}bo.forEach(function(bv){bq(ak,bv)});bf()}function bk(bv){bq(aT,bv)}function a5(bx){var bw=aw(ay.startElem);var bv=X(at,bx);a3(ak,ay,bw,bv)}function bq(by,bx){if(!Z(bx.startElem)||!Z(bx.endElem)){var bw=bj(bx);bx.startElem=bw["startElem"];bx.endElem=bw["endElem"]}var bz=aw(bx.startElem);var bv=aw(bx.endElem);a3(by,bx,bz,bv)}function a3(bx,bw,by,bv){var bA=aX(bw,"type");switch(bA){case"bezier":var bB=aG(bw,by,bv);aS(bx,bw,by,bB("d1Pos"),bB("d2Pos"),bv,0);break;case"straight":aP(bx,bw,by,bv);break;case"broken":var bz=aG(bw,by,bv);aL(bx,bw,by,bz("d1Pos"),bz("d2Pos"),bv)}}function aS(bG,bI,bF,bz,bv,bB,by){var bC=aX(bI,"lineStyle");var bE=(bC==="arrow");var bx=Q(L((bv.x-bB.x),2)+L((bv.y-bB.y),2));var bA=(by+10)/bx;var bH=by/bx;var bw={};bw.x=bB.x+bH*(bv.x-bB.x);bw.y=bB.y+bH*(bv.y-bB.y);var bD={};bD.x=bE?bB.x+bA*(bv.x-bB.x):bB.x;bD.y=bE?bB.y+bA*(bv.y-bB.y):bB.y;bG.save();bG.beginPath();if(bG!==ak){bG.strokeStyle=bu.lineColor}else{bG.strokeStyle=bu.lineActiveColor}bG.moveTo(bF.x,bF.y);bG.bezierCurveTo(bz.x,bz.y,bv.x,bv.y,bD.x,bD.y);bG.stroke();bG.beginPath();bG.arc(bB.x,bB.y,by,0,2*Math.PI);bG.stroke();bE&&(a6(bG,bv,bw,bD));bG.restore()}function br(bv,bx,by,bw){bv.beginPath();bv.translate(by.x,by,y);bv.rotate(Math.atan2(bw.y-bx.y,bw.x-bx.x));bv.moveTo(0,0);bv.lineTo(-10,3);bv.lineTo(-10,-3);bv.lineTo(0,0);bv.stroke();bv.fill()}function aP(by,bx,bz,bw){if(by!==ak){by.strokeStyle=bu.lineColor}else{by.strokeStyle=bu.lineActiveColor}by.save();by.beginPath();by.moveTo(bz.x,bz.y);by.lineTo(bw.x,bw.y);by.stroke();
var bv=aX(bx,"lineStyle");if(bv=="arrow"){a6(by,bz,bw)}by.restore()}function aL(by,bx,bz,bB,bA,bw){by.save();by.beginPath();if(by!==ak){by.strokeStyle=bu.lineColor}else{by.strokeStyle=bu.lineActiveColor}by.moveTo(bz.x,bz.y);by.lineTo(bB.x,bB.y);by.lineTo(bA.x,bA.y);by.lineTo(bw.x,bw.y);by.stroke();var bv=aX(bx,"lineStyle");if(bv=="arrow"){a6(by,bA,bw)}by.restore()}function a6(bw,bx,bv){bw.save();bw.beginPath();bw.translate(bv.x,bv.y);bw.rotate(Math.atan2(bv.y-bx.y,bv.x-bx.x));bw.lineTo(-10,3);bw.lineTo(-10,-3);bw.lineTo(0,0);bw.fillStyle=bu.arrowColor;bw.fill()}this.addNode=function(bx){var bz=document.createElement("div");F(bz,[Y.ndCss,Y.ndJs]);bz.style.left=bx.pos.x+"px";bz.style.top=bx.pos.y+"px";bz.innerHTML=bx.html;bz.htmlStr=bx.html;bz.nodeid=isNaN(bx.nodeid)?null:bx.nodeid;bz.anchors=bx.anchors;var by=bz.children[0];F(by,Y.inNdJs);aA.appendChild(bz);var bw=ax.push(bz);bw.setAttribute("node-id",bw.nodeid);by.nodeid=bz.nodeid;var bv=n(bz);g(bv,true);return bz};var a2=V("deleteLineBefore,deleteLineAfter,linkLineStart,linkLineBefore,linkLineAfter,clickLine",false);this.listen=function(){if(arguments.length===1&&R(arguments[0])){aW=ag(arguments[0],aW)}else{if(arguments.length>=2&&A(arguments[1])){var bw=arguments[0],bv=arguments[1];if(a2(bw)){aW[bw]=bv}}}};this.getAllNodes=function(){return ax.toArray()};this.getAllLines=function(){return bd.fiterData()};this.getAllNodesInfo=function(){return ax.fiterData()};this.deleteNodeById=function(){var bv=[];z(arguments).forEach(function(bw){var by=ab(bw);bd.deleteByNodeId(by);var bx=ax.deleteById(by);bv.push(bx);aN();ah()});return bv};this.clear=function(){while(ax.length){var bv=ax.peek();bd.deleteByNodeId(bv.nodeid);ax.deleteById(bv.nodeid)}aN();ah()};this.init=function(by,bx){if(!G(by)||!G(bx)){I("unknown arguments in init(nodeStack,lineStack)")}ax.clear();for(var bv=0;bv<by.length;bv++){var bw=by[bv];this.addNode(bw)}bd.clear();bd.addAll(bx);aN()}}C.prototype.version=ac;return C});